<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu PWA JS Puro - Completo</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
      color: #333;
      transition: background 0.3s, color 0.3s;
      padding: 20px;
    }
    h1, h2, p { text-align: center; }
    input, button { margin-top: 10px; padding: 10px; width: 250px; font-size: 16px; }
    div.screen { display: none; flex-direction: column; align-items: center; margin-top: 20px; }
    button { cursor: pointer; }
    /* Tema Dark/Light */
    body[data-theme="dark"] { background: #1e1e1e; color: #f5f5f5; }
    body[data-theme="dark"] input, body[data-theme="dark"] button { background: #333; color: #f5f5f5; border: none; }
    body[data-theme="light"] input, body[data-theme="light"] button { background: #fff; color: #333; border: 1px solid #ccc; }

    footer {
      margin-top: auto;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="loginForm" class="screen">
  <h1>Login</h1>
  <input type="text" id="username" placeholder="Usuário" autocomplete="off" name="user_fake">
  <input type="password" id="password" placeholder="Senha" autocomplete="off" name="pass_fake">
  <button id="btnLogin">Entrar</button>
  <p id="loginMsg"></p>
  <button id="btnGoRegister">Cadastrar novo usuário</button>
</div>

<!-- Registro -->
<div id="registerForm" class="screen">
  <h1>Cadastro</h1>
  <input type="text" id="regUsername" placeholder="Novo usuário">
  <input type="password" id="regPassword" placeholder="Nova senha">
  <button id="btnRegister">Cadastrar</button>
  <p id="registerMsg"></p>
  <button id="btnGoLogin">Voltar ao login</button>
</div>

<!-- App principal -->
<div id="app" class="screen">
  <h1 id="mensagem">Olá, usuário! 👋</h1>
  <button id="botao">Mudar mensagem</button>
  <button id="tema">Alternar tema 🌙💡</button>
  <button id="changePasswordBtn">Alterar senha 🔑</button>
  <button id="deleteUserBtn">Excluir usuário ❌</button>
  <button id="showUsersBtn">Ver usuários cadastrados 👥</button>
  <button id="logout">Sair</button>
</div>

<!-- Formulário Alterar Senha -->
<div id="changePasswordForm" class="screen">
  <h1>Alterar senha</h1>
  <input type="password" id="newPassword" placeholder="Nova senha">
  <button id="btnChangePassword">Salvar</button>
  <p id="changePasswordMsg"></p>
  <button id="btnCancelChangePassword">Cancelar</button>
</div>

<!-- Tela de usuários cadastrados -->
<div id="userListScreen" class="screen">
  <h1>Usuários cadastrados</h1>
  <div id="userList"></div>
  <button id="btnBackToApp">Voltar</button>
</div>

<footer class="footer">
  <p>Versão: <span id="js-pwa-version"></span></p>
</footer>

<script>
// ---------------- Versão do App ----------------
const appVersion = '1.0.2'; // altere a cada atualização

window.addEventListener('DOMContentLoaded', () => {
  const versionEl = document.getElementById('js-pwa-version');
  if (versionEl) versionEl.textContent = appVersion;
});

// ---------------- Elementos ----------------
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const app = document.getElementById('app');
const changePasswordForm = document.getElementById('changePasswordForm');
const userListScreen = document.getElementById('userListScreen');
const userList = document.getElementById('userList');
const btnBackToApp = document.getElementById('btnBackToApp');
const showUsersBtn = document.getElementById('showUsersBtn');

const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const btnLogin = document.getElementById('btnLogin');
const loginMsg = document.getElementById('loginMsg');
const btnGoRegister = document.getElementById('btnGoRegister');

const regUsernameInput = document.getElementById('regUsername');
const regPasswordInput = document.getElementById('regPassword');
const btnRegister = document.getElementById('btnRegister');
const registerMsg = document.getElementById('registerMsg');
const btnGoLogin = document.getElementById('btnGoLogin');

const botao = document.getElementById('botao');
const botaoTema = document.getElementById('tema');
const logoutBtn = document.getElementById('logout');
const changePasswordBtn = document.getElementById('changePasswordBtn');
const deleteUserBtn = document.getElementById('deleteUserBtn');

const newPasswordInput = document.getElementById('newPassword');
const btnChangePassword = document.getElementById('btnChangePassword');
const changePasswordMsg = document.getElementById('changePasswordMsg');
const btnCancelChangePassword = document.getElementById('btnCancelChangePassword');

const mensagem = document.getElementById('mensagem');
const body = document.body;

let db;

// ---------------- IndexedDB ----------------
const request = indexedDB.open('MeuPWA', 1);
request.onupgradeneeded = (event) => {
  db = event.target.result;
  if (!db.objectStoreNames.contains('usuarios')) {
    const store = db.createObjectStore('usuarios', { keyPath: 'username' });
    store.createIndex('username', 'username', { unique: true });
  }
};

request.onsuccess = (event) => {
  db = event.target.result;
  console.log('✅ Banco IndexedDB aberto');
  checkLoggedUser();
};
request.onerror = (event) => console.error('❌ Erro ao abrir IndexedDB', event.target.error);

// ---------------- Funções ----------------
function showScreen(screen){
  loginForm.style.display = 'none';
  registerForm.style.display = 'none';
  app.style.display = 'none';
  changePasswordForm.style.display = 'none';
  userListScreen.style.display = 'none';

  if(screen==='login') loginForm.style.display='flex';
  if(screen==='register') registerForm.style.display='flex';
  if(screen==='app') app.style.display='flex';
  if(screen==='changePassword') changePasswordForm.style.display='flex';
  if(screen==='userList') userListScreen.style.display='flex';
}

function showApp(user){
  mensagem.textContent = `Olá, ${user}! 👋`;
  showScreen('app');
}

function verificarLogin(username, password, callback){
  const tx = db.transaction(['usuarios'],'readonly');
  const store = tx.objectStore('usuarios');
  const req = store.get(username);
  req.onsuccess = () => callback(req.result && req.result.password === password);
}

function updatePassword(username, newPassword, callback){
  const tx = db.transaction(['usuarios'],'readwrite');
  const store = tx.objectStore('usuarios');
  const req = store.get(username);
  req.onsuccess = () => {
    const user = req.result;
    if(user){
      user.password = newPassword;
      const upd = store.put(user);
      upd.onsuccess = () => callback(true);
      upd.onerror = () => callback(false);
    } else callback(false);
  }
}

function deleteUser(username, callback){
  const tx = db.transaction(['usuarios'],'readwrite');
  const store = tx.objectStore('usuarios');
  const req = store.delete(username);
  req.onsuccess = () => callback(true);
  req.onerror = () => callback(false);
}

function checkLoggedUser(){
  const user = localStorage.getItem('loggedUser');
  if(user) showApp(user);
  else showScreen('login');
}

// ---------------- Eventos ----------------
btnLogin.addEventListener('click', ()=>{
  const user = usernameInput.value;
  const pass = passwordInput.value;
  verificarLogin(user, pass, success=>{
    if(success){
      localStorage.setItem('loggedUser', user);
      showApp(user);
    } else loginMsg.textContent='Usuário ou senha incorretos!';
  });
});

btnGoRegister.addEventListener('click', ()=>showScreen('register'));
btnGoLogin.addEventListener('click', ()=>showScreen('login'));

btnRegister.addEventListener('click', ()=>{
  const user = regUsernameInput.value.trim();
  const pass = regPasswordInput.value.trim();
  if(!user || !pass){ registerMsg.textContent='Preencha todos os campos!'; return; }
  const tx = db.transaction(['usuarios'],'readwrite');
  const store = tx.objectStore('usuarios');
  const req = store.add({username:user,password:pass});
  req.onsuccess = ()=>{
    registerMsg.textContent='Usuário cadastrado!';
    regUsernameInput.value='';
    regPasswordInput.value='';
  };
  req.onerror = ()=>registerMsg.textContent='Erro: usuário já existe!';
});

botao.addEventListener('click', ()=>mensagem.textContent='Você clicou no botão! 🚀');

botaoTema.addEventListener('click', ()=>{
  const newTheme = body.dataset.theme==='dark'?'light':'dark';
  body.dataset.theme = newTheme;
  localStorage.setItem('theme', newTheme);
});

const savedTheme = localStorage.getItem('theme');
if(savedTheme) body.dataset.theme=savedTheme;

changePasswordBtn.addEventListener('click', ()=>{
  changePasswordMsg.textContent='';
  newPasswordInput.value='';
  showScreen('changePassword');
});

btnCancelChangePassword.addEventListener('click', ()=>showApp(localStorage.getItem('loggedUser')));

btnChangePassword.addEventListener('click', ()=>{
  const newPass = newPasswordInput.value.trim();
  if(!newPass){ changePasswordMsg.textContent='Digite a nova senha!'; return; }
  const user = localStorage.getItem('loggedUser');
  updatePassword(user,newPass,success=>{
    changePasswordMsg.textContent = success?'Senha atualizada!':'Erro ao atualizar';
    if(success) newPasswordInput.value='';
  });
});

deleteUserBtn.addEventListener('click', ()=>{
  const user = localStorage.getItem('loggedUser');
  if(confirm(`Tem certeza que deseja excluir o usuário "${user}"?`)){
    deleteUser(user,success=>{
      if(success){
        alert('Usuário excluído!');
        localStorage.removeItem('loggedUser');
        showScreen('login');
      } else alert('Erro ao excluir usuário.');
    });
  }
});

logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('loggedUser');
  usernameInput.value = '';
  passwordInput.value = '';
  loginMsg.textContent = '';
  showScreen('login');
});

// ---------------- Nova tela: listar usuários ----------------
function listarUsuarios() {
  userList.innerHTML = ''; 
  const tx = db.transaction(['usuarios'], 'readonly');
  const store = tx.objectStore('usuarios');
  const req = store.openCursor();
  
  req.onsuccess = (event) => {
    const cursor = event.target.result;
    if (cursor) {
      const { username, password } = cursor.value;

      const container = document.createElement('div');
      container.style.marginBottom = '15px';

      const userInput = document.createElement('input');
      userInput.value = username;
      userInput.readOnly = true;

      const passInput = document.createElement('input');
      passInput.value = password;
      passInput.type = 'text';
      passInput.readOnly = true;

      container.appendChild(userInput);
      container.appendChild(passInput);
      userList.appendChild(container);

      cursor.continue();
    } else if (!userList.innerHTML) {
      userList.innerHTML = '<p>Nenhum usuário cadastrado.</p>';
    }
  };
}

showUsersBtn.addEventListener('click', () => {
  listarUsuarios();
  showScreen('userList');
});

btnBackToApp.addEventListener('click', () => {
  showApp(localStorage.getItem('loggedUser'));
});

// ---------------- Service Worker ----------------
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'version') {
      const versionEl = document.getElementById('js-pwa-version');
      if (versionEl) versionEl.textContent = event.data.version;
    }
  });

  navigator.serviceWorker.getRegistrations()
    .then(regs => Promise.all(regs.map(reg => reg.unregister())))
    .then(() => {
      console.log('❌ Service Worker antigo removido');
      return navigator.serviceWorker.register('service-worker.js');
    })
    .then(() => console.log('✅ Novo Service Worker registrado e cache atualizado'))
    .catch(err => console.error('❌ Falha ao registrar SW:', err));
}
</script>

</body>
</html>




