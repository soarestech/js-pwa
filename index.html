<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu PWA JS Puro</title>

  <!-- Ícone e Manifest -->
  <link rel="manifest" href="js-pwa/manifest.json">
  <link rel="icon" href="js-pwa/icon-192.png" type="image/png">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f5f5f5;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }

    h1 { color: inherit; text-align: center; }

    button, input {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    input { width: 200px; }

    /* Dark/Light */
    @media (prefers-color-scheme: dark) {
      body { background: #1e1e1e; color: #f5f5f5; }
      button, input { background: #333; color: #f5f5f5; border: none; }
    }

    @media (prefers-color-scheme: light) {
      body { background: #f5f5f5; color: #333; }
      button, input { background: #fff; color: #333; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <h1 id="mensagem">Olá, mundo! 👋</h1>
  <button id="botao">Mudar mensagem</button>
  <button id="tema">Alternar tema 🌙💡</button>

  <hr style="width:80%; margin:20px 0;">

  <!-- Login Simples -->
  <h2>Login Offline</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="senha" placeholder="Senha"><br>
  <button id="cadastrar">Cadastrar</button>
  <button id="login">Login</button>

  <hr style="width:80%; margin:20px 0;">

  <!-- Salvar Mensagens -->
  <h2>Mensagens Offline</h2>
  <input type="text" id="msg" placeholder="Digite uma mensagem"><br>
  <button id="salvarMsg">Salvar Mensagem</button>
  <button id="listarMsg">Listar Mensagens no Console</button>

  <script>
    const botao = document.getElementById('botao');
    const botaoTema = document.getElementById('tema');
    const mensagem = document.getElementById('mensagem');
    const body = document.body;

    const emailInput = document.getElementById('email');
    const senhaInput = document.getElementById('senha');
    const btnCadastrar = document.getElementById('cadastrar');
    const btnLogin = document.getElementById('login');

    const msgInput = document.getElementById('msg');
    const btnSalvarMsg = document.getElementById('salvarMsg');
    const btnListarMsg = document.getElementById('listarMsg');

    let db;

    // ---------------- IndexedDB ----------------
    const request = indexedDB.open('MeuPWA_DB', 1);

    request.onupgradeneeded = event => {
      db = event.target.result;
      if (!db.objectStoreNames.contains('usuarios')) {
        db.createObjectStore('usuarios', { keyPath: 'email' });
      }
      if (!db.objectStoreNames.contains('mensagens')) {
        db.createObjectStore('mensagens', { keyPath: 'id', autoIncrement: true });
      }
    };

    request.onsuccess = event => {
      db = event.target.result;
      console.log('✅ IndexedDB pronta');
    };

    request.onerror = event => console.error('❌ IndexedDB erro:', event.target.error);

    // ---------------- Botões ----------------
    botao.addEventListener('click', () => {
      mensagem.textContent = 'Você clicou no botão! 🚀';
    });

    botaoTema.addEventListener('click', () => {
      if (body.dataset.theme === 'dark') {
        body.dataset.theme = 'light';
        body.style.background = '#f5f5f5';
        body.style.color = '#333';
      } else {
        body.dataset.theme = 'dark';
        body.style.background = '#1e1e1e';
        body.style.color = '#f5f5f5';
      }
    });

    // ---------------- Login Simples ----------------
    btnCadastrar.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const senha = senhaInput.value.trim();
      if (!email || !senha) return alert('Preencha email e senha');
      const tx = db.transaction('usuarios', 'readwrite');
      const store = tx.objectStore('usuarios');
      store.add({ email, senha });
      tx.oncomplete = () => alert('✅ Usuário cadastrado!');
      tx.onerror = () => alert('❌ Usuário já existe');
    });

    btnLogin.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const senha = senhaInput.value.trim();
      const tx = db.transaction('usuarios', 'readonly');
      const store = tx.objectStore('usuarios');
      const req = store.get(email);
      req.onsuccess = () => {
        if (req.result && req.result.senha === senha) {
          alert('✅ Login ok!');
        } else {
          alert('❌ Login falhou');
        }
      };
    });

    // ---------------- Mensagens Offline ----------------
    btnSalvarMsg.addEventListener('click', () => {
      const texto = msgInput.value.trim();
      if (!texto) return alert('Digite uma mensagem');
      const tx = db.transaction('mensagens', 'readwrite');
      const store = tx.objectStore('mensagens');
      store.add({ texto, data: new Date() });
      tx.oncomplete = () => {
        alert('✅ Mensagem salva!');
        msgInput.value = '';
      };
    });

    btnListarMsg.addEventListener('click', () => {
      const tx = db.transaction('mensagens', 'readonly');
      const store = tx.objectStore('mensagens');
      const req = store.getAll();
      req.onsuccess = () => console.log('Mensagens:', req.result);
    });

    // ---------------- Service Worker + Atualização ----------------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('js-pwa/service-worker.js')
        .then(reg => {
          console.log('✅ Service Worker registrado');
          reg.onupdatefound = () => {
            const newWorker = reg.installing;
            newWorker.onstatechange = () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                alert('🆕 Nova versão disponível! Atualize a página.');
              }
            };
          };
        })
        .catch(err => console.error('❌ Falha ao registrar o Service Worker:', err));
    }
  </script>
</body>
</html>




